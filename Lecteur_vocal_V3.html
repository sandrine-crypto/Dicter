<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lecteur vocal 2 colonnes – V3</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #60a5fa; /* blue-400 */
      --ok: #34d399; /* emerald-400 */
      --warn: #f59e0b; /* amber-500 */
      --err: #f43f5e; /* rose-500 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: grid; grid-template-rows: auto 1fr auto; gap: 16px; padding: 16px;
    }
    header, footer, .panel { background: var(--panel); border: 1px solid #1f2937; border-radius: 16px; }
    header, footer { padding: 12px 16px; }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    .panel { padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .col { display: grid; gap: 12px; }

    textarea, input, select, button { 
      background: #0b1220; border: 1px solid #223045; color: var(--text); border-radius: 10px; 
      padding: 10px 12px; font-size: 14px; outline: none; width: 100%;
    }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button { cursor: pointer; width: auto; }
    button.primary { background: #1d4ed8; border-color: #1d4ed8; }
    button.ghost { background: transparent; border-color: #334155; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .status { font-size: 13px; color: var(--muted); }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #334155; }
    .badge.ok{ color: #052e1a; background: #34d399; border-color: #10b981; }
    .badge.warn{ color: #3a2403; background: #fbbf24; border-color: #f59e0b; }
    .badge.err{ color: #4a0b13; background: #fda4af; border-color: #f43f5e; }

    .stage {
      display: grid; place-items: center; height: 48vh; border-radius: 20px; border: 1px dashed #334155;
      background: #0b1220;
    }
    .current {
      text-align: center; line-height: 1.1;
    }
    .label { font-size: clamp(18px, 3vw, 28px); color: var(--muted); margin-bottom: 8px; }
    .value { font-size: clamp(64px, 12vw, 180px); font-weight: 800; letter-spacing: .02em; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid #1f2937; }
    tr.active { background: #0b1a33; }

    .mini { font-size: 12px; color: var(--muted); }
    .spacer { height: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Lecteur vocal 2 colonnes – V3</h1>
    <div class="status" id="statusLine">Prêt.</div>
  </header>

  <div class="grid">
    <section class="panel col" id="dataPanel">
      <div class="row">
        <div style="flex:1">
          <label for="paste" class="mini">Collez ici depuis Excel (2 colonnes séparées par des tabulations). Exemple : « ech 1\t23,4 »</label>
          <textarea id="paste" placeholder="ech 1\t23\nech 2\t10,2\nech 3\t2,3"></textarea>
        </div>
      </div>
      <div class="row">
        <button id="parseBtn" class="primary">Analyser</button>
        <input type="file" id="csvFile" accept=".csv,.tsv,text/csv" />
        <button id="loadCsvBtn" class="ghost">Charger CSV/TSV</button>
        <span class="mini">Le fichier doit contenir 2 colonnes.</span>
      </div>

      <div class="spacer"></div>
      <div class="row">
        <div class="badge warn" id="recogBadge">Reco: inactif</div>
        <div class="badge" id="synthBadge">TTS: inconnu</div>
        <div class="badge" id="itemsBadge">0 lignes</div>
      </div>

      <div class="spacer"></div>
      <div style="overflow:auto; max-height: 220px; border:1px solid #223045; border-radius: 12px;">
        <table id="preview">
          <thead><tr><th>#</th><th>Texte</th><th>Nombre</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="panel col" id="controlPanel">
      <div class="stage">
        <div class="current">
          <div class="label" id="currentLabel">—</div>
          <div class="value" id="currentValue">—</div>
        </div>
      </div>

      <div class="row">
        <button id="startBtn" class="primary">Démarrer</button>
        <button id="pauseBtn" class="ghost" disabled>Pause</button>
        <button id="resumeBtn" class="ghost" disabled>Reprendre</button>
        <button id="prevBtn" class="ghost" disabled>Précédent</button>
        <button id="nextBtn" class="ghost" disabled>Suivant</button>
        <button id="stopBtn" class="ghost" disabled>Stop</button>
      </div>

      <div class="spacer"></div>
      <details>
        <summary>Paramètres</summary>
        <div class="row">
          <label class="mini" style="width:180px">Mot déclencheur</label>
          <input id="trigger" value="oui" style="max-width:220px" />
          <label class="mini" style="width:180px">Langue</label>
          <select id="lang" style="max-width:220px">
            <option value="fr-FR" selected>fr-FR</option>
            <option value="en-US">en-US</option>
            <option value="es-ES">es-ES</option>
            <option value="ar-SA">ar-SA</option>
          </select>
          <label class="mini" style="width:200px">Attente auto (s)</label>
          <input id="autoDelay" type="number" min="5" max="900" value="120" style="max-width:140px" />
        </div>
        <div class="row">
          <label class="mini" style="width:180px">Lire aussi le texte</label>
          <select id="readLabel" style="max-width:220px">
            <option value="yes" selected>oui</option>
            <option value="no">non</option>
          </select>
          <label class="mini" style="width:180px">Volume</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
          <label class="mini" style="width:180px">Vitesse</label>
          <input id="rate" type="range" min="0.5" max="1.5" step="0.01" value="1" />
        </div>
      </details>
    </section>
  </div>

  <footer>
    <div class="mini">
      Guide: collez vos données, cliquez Analyser, puis Démarrer. Dites « OUI » (modifiable) pour avancer. Le passage automatique déclenche après l'attente configurée.
    </div>
  </footer>

<script>
(function(){
  /*** ÉTAT ***/
  const state = {
    items: /** @type {{label:string, raw:string, display:string, value:number|null}[]} */([]),
    idx: -1,
    speaking: false,
    paused: false,
    autoTimer: null,
    recog: null,
    recogActive: false,
    voices: [],
  };

  /*** RÉFÉRENCES UI ***/
  const el = (id)=>document.getElementById(id);
  const paste = el('paste');
  const parseBtn = el('parseBtn');
  const csvFile = el('csvFile');
  const loadCsvBtn = el('loadCsvBtn');
  const itemsBadge = el('itemsBadge');
  const recogBadge = el('recogBadge');
  const synthBadge = el('synthBadge');
  const tableBody = document.querySelector('#preview tbody');
  const currentLabel = el('currentLabel');
  const currentValue = el('currentValue');
  const statusLine = el('statusLine');

  const startBtn = el('startBtn');
  const pauseBtn = el('pauseBtn');
  const resumeBtn = el('resumeBtn');
  const prevBtn = el('prevBtn');
  const nextBtn = el('nextBtn');
  const stopBtn = el('stopBtn');

  const trigger = /** @type {HTMLInputElement} */(el('trigger'));
  const lang = /** @type {HTMLSelectElement} */(el('lang'));
  const autoDelay = /** @type {HTMLInputElement} */(el('autoDelay'));
  const readLabel = /** @type {HTMLSelectElement} */(el('readLabel'));
  const volume = /** @type {HTMLInputElement} */(el('volume'));
  const rate = /** @type {HTMLInputElement} */(el('rate'));

  /*** UTIL ***/
  const setStatus = (t)=> statusLine.textContent = t;
  const clampIdx = ()=> Math.min(Math.max(state.idx, 0), state.items.length-1);
  const isEmpty = (v)=> v==null || String(v).trim()==="";

  function normalizeDecimal(s){
    // Convertir points en virgules pour l'affichage, et produire aussi un nombre JS
    if (typeof s !== 'string') s = String(s ?? '');
    s = s.trim();
    // Excel FR colle souvent « 1\t23,4 ». Ici on prend tout ce qui ressemble à nombre avec , ou .
    // On interdit les séparateurs de milliers. On supprime les espaces fines et non‑break.
    s = s.replace(/[\s\u00A0\u202F]/g, '');
    // Si les deux existent, on considère que le point n'est pas un séparateur de milliers, on garde le dernier symbole comme décimal.
    if (s.includes(',') && s.includes('.')){
      // L'utilisateur veut traiter les points comme des virgules. On remplace tout par virgule, puis on convertit.
      s = s.replace(/\./g, ',');
    }
    // Affichage avec virgule
    const display = s.replace(/\./g, ',');
    // Valeur numérique: remplacer virgule par point pour parseFloat
    const num = parseFloat(display.replace(/,/g, '.'));
    const value = Number.isFinite(num) ? num : null;
    return {display, value, raw: s};
  }

  function parseText(text){
    /**
     * Attend 2 colonnes par ligne, séparées par tabulation ou point‑virgule.
     * Exemples:
     *   "ech 1\t23,4"  |  "ech 2;10.2"
     */
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    const items = [];
    for (let i=0;i<lines.length;i++){
      const line = lines[i];
      const parts = line.split(/\t|;|\s{2,}/); // tab, point‑virgule, ou >=2 espaces
      if (parts.length < 2) continue;
      const label = parts[0].trim();
      const nstr = parts.slice(1).join(' ').trim();
      const {display, value, raw} = normalizeDecimal(nstr);
      items.push({label, raw, display, value});
    }
    return items;
  }

  function renderTable(){
    tableBody.innerHTML = '';
    state.items.forEach((it, i)=>{
      const tr = document.createElement('tr');
      if (i===state.idx) tr.classList.add('active');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(it.label)}</td><td>${escapeHtml(it.display)}</td>`;
      tableBody.appendChild(tr);
    });
    itemsBadge.textContent = `${state.items.length} lignes`;
  }

  function showCurrent(){
    const it = state.items[state.idx] || {label:'—', display:'—'};
    currentLabel.textContent = it.label || '—';
    currentValue.textContent = it.display || '—';
    renderTable();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
    })[c]);
  }

  /*** TTS ***/
  function updateVoices(){
    state.voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    const ok = state.voices && state.voices.length>0;
    synthBadge.textContent = ok ? `TTS: ${state.voices.length} voix` : 'TTS: non dispo';
  }
  if ('speechSynthesis' in window){
    updateVoices();
    window.speechSynthesis.onvoiceschanged = updateVoices;
  } else {
    synthBadge.textContent = 'TTS: non supporté';
  }

  function pickVoice(langCode){
    const list = state.voices;
    if (!list || !list.length) return null;
    // voix exacte, sinon même langue, sinon première
    return list.find(v=>v.lang===langCode) || list.find(v=>v.lang.startsWith(langCode.split('-')[0])) || list[0];
  }

  function speak(text){
    if (!('speechSynthesis' in window)) return Promise.resolve();
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const v = pickVoice(lang.value);
    if (v) u.voice = v;
    u.lang = lang.value;
    u.volume = parseFloat(volume.value);
    u.rate = parseFloat(rate.value);
    state.speaking = true;
    return new Promise(res=>{
      u.onend = ()=>{ state.speaking = false; res(); };
      u.onerror = ()=>{ state.speaking = false; res(); };
      speechSynthesis.speak(u);
    });
  }

  async function speakCurrent(){
    const it = state.items[state.idx];
    if (!it) return;
    const sayLabel = readLabel.value === 'yes' && it.label ? it.label + ', ' : '';
    // Pour une meilleure diction, donner la valeur telle qu'affichée (avec virgule) pour fr-FR
    const phrase = `${sayLabel}${it.display}`;
    await speak(phrase);
  }

  /*** AUTO AVANCE ***/
  function clearAuto(){ if (state.autoTimer){ clearTimeout(state.autoTimer); state.autoTimer=null; } }
  function scheduleAuto(){
    clearAuto();
    const ms = Math.max(5, Number(autoDelay.value||120)) * 1000;
    state.autoTimer = setTimeout(()=>{
      setStatus('Avance auto');
      next();
    }, ms);
  }

  /*** RECO VOCAL ***/
  function setupRecog(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR){ recogBadge.textContent = 'Reco: non supportée'; return; }
    if (state.recog) return; // déja
    const r = new SR();
    r.continuous = true;
    r.interimResults = false;
    r.lang = lang.value; // même langue que TTS
    r.onstart = ()=>{ state.recogActive = true; recogBadge.textContent='Reco: active'; };
    r.onend = ()=>{ state.recogActive = false; recogBadge.textContent='Reco: stoppée'; if (state.idx>=0){ tryStartRecog(); } };
    r.onerror = (e)=>{ recogBadge.textContent = 'Reco: erreur'; console.warn('Reco error', e); };
    r.onresult = (evt)=>{
      for (let i=evt.resultIndex;i<evt.results.length;i++){
        const t = evt.results[i][0].transcript.trim().toLowerCase();
        const wanted = (trigger.value||'').trim().toLowerCase();
        if (!wanted) continue;
        if (t.includes(wanted)){
          setStatus(`Détecté: ${t}`);
          next();
          return;
        }
      }
    };
    state.recog = r;
  }

  function tryStartRecog(){
    if (!state.recog){ setupRecog(); }
    if (!state.recog) return;
    try {
      if (!state.recogActive){ state.recog.start(); }
    } catch(e){ /* start en double */ }
  }

  function stopRecog(){
    if (state.recog && state.recogActive){ try{ state.recog.stop(); }catch(e){} }
  }

  /*** CONTRÔLES ***/
  function updateControls(){
    const hasItems = state.items.length>0;
    const running = state.idx>=0;
    startBtn.disabled = !hasItems || running;
    pauseBtn.disabled = !running || state.paused;
    resumeBtn.disabled = !running || !state.paused;
    prevBtn.disabled = !running || state.idx<=0;
    nextBtn.disabled = !running || state.idx>=state.items.length-1;
    stopBtn.disabled = !running;
  }

  async function start(){
    if (state.items.length===0){ setStatus('Aucune donnée'); return; }
    state.idx = 0;
    state.paused = false;
    showCurrent();
    updateControls();
    tryStartRecog();
    await speakCurrent();
    scheduleAuto();
  }

  function pause(){
    state.paused = true; clearAuto();
    window.speechSynthesis && window.speechSynthesis.cancel();
    stopRecog();
    setStatus('Pause');
    updateControls();
  }

  async function resume(){
    if (state.idx<0) return;
    state.paused = false;
    updateControls();
    tryStartRecog();
    await speakCurrent();
    scheduleAuto();
  }

  async function prev(){
    if (state.idx<=0) return;
    state.idx--; showCurrent(); updateControls(); clearAuto();
    await speakCurrent(); scheduleAuto();
  }

  async function next(){
    if (state.idx>=state.items.length-1){ stop(); return; }
    state.idx++; showCurrent(); updateControls(); clearAuto();
    await speakCurrent(); scheduleAuto();
  }

  function stop(){
    clearAuto();
    window.speechSynthesis && window.speechSynthesis.cancel();
    stopRecog();
    state.idx = -1; state.paused=false; showCurrent(); updateControls();
    setStatus('Arrêté');
  }

  /*** IMPORT ***/
  function loadFromTextarea(){
    const text = paste.value || '';
    const items = parseText(text);
    state.items = items;
    state.idx = -1;
    showCurrent(); updateControls();
    setStatus(items.length? 'Données chargées' : 'Aucune ligne valide');
  }

  function readFile(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result||''));
      r.onerror = rej;
      r.readAsText(file, 'utf-8');
    });
  }

  async function loadCsv(){
    const f = csvFile.files && csvFile.files[0];
    if (!f){ setStatus('Choisissez un fichier CSV/TSV'); return; }
    const text = await readFile(f);
    // Remplacer virgules des CSV par tab si séparateur comma et structure "a,b"
    // Ici on tente TSV d'abord, sinon CSV standard.
    let lines = text.split(/\r?\n/).filter(Boolean);
    let items = [];
    for (const line of lines){
      let parts = line.split('\t');
      if (parts.length<2){ parts = line.split(','); }
      if (parts.length<2){ parts = line.split(';'); }
      if (parts.length<2) continue;
      const label = parts[0].trim();
      const nstr = parts.slice(1).join(' ').trim();
      const {display, value, raw} = normalizeDecimal(nstr);
      items.push({label, raw, display, value});
    }
    state.items = items; state.idx=-1; showCurrent(); updateControls();
    setStatus(items.length? 'Fichier chargé' : 'Aucune ligne valide');
  }

  /*** ÉVÉNEMENTS ***/
  parseBtn.addEventListener('click', loadFromTextarea);
  loadCsvBtn.addEventListener('click', loadCsv);

  startBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', pause);
  resumeBtn.addEventListener('click', resume);
  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);
  stopBtn.addEventListener('click', stop);

  lang.addEventListener('change', ()=>{
    if (state.recog){ try{ state.recog.stop(); }catch(e){} state.recog.lang = lang.value; tryStartRecog(); }
  });

  // Coller = analyser direct pour réduire les clics
  paste.addEventListener('paste', (e)=>{
    setTimeout(()=>{ loadFromTextarea(); }, 0);
  });

  // Raccourcis clavier
  document.addEventListener('keydown', (e)=>{
    if (state.idx<0) return;
    if (e.key==='ArrowRight'){ e.preventDefault(); next(); }
    if (e.key==='ArrowLeft'){ e.preventDefault(); prev(); }
    if (e.key.toLowerCase()===' '){ e.preventDefault(); state.paused? resume(): pause(); }
  });

  // Détection permissions micro basique
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({audio:true}).then(()=>{
      recogBadge.textContent = 'Reco: micro autorisé';
    }).catch(()=>{
      recogBadge.textContent = 'Reco: micro bloqué';
    });
  }

  setStatus('Prêt. Collez vos données, puis Analyser.');
  showCurrent(); updateControls();
})();
</script>
</body>
</html>
