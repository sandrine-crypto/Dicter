<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lecteur vocal 2 colonnes</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; --a:#2563eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color: var(--t); margin:0; background:#fafafa; }
    .container{ max-width: 960px; margin: 0 auto; padding: 24px; }
    h1{ font-size: 24px; margin: 0 0 8px; }
    .muted{ color: var(--m); font-size: 14px; margin-bottom: 16px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width: 900px){ .grid{ grid-template-columns: 2fr 1fr; } }
    .card{ background:white; border:1px solid var(--b); border-radius: 16px; padding: 16px; }
    label{ font-size: 14px; font-weight: 600; display:block; margin-bottom:6px; }
    textarea,input,select{ width:100%; border:1px solid var(--b); border-radius:12px; padding:10px; font-size:14px; }
    textarea{ min-height: 180px; resize: vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .controls{ display:flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
    button{ border:1px solid var(--b); background:white; padding:8px 12px; border-radius: 12px; cursor:pointer; font-size:14px; }
    button[disabled]{ opacity:0.5; cursor:not-allowed; }
    .status{ font-size: 14px; margin-top: 8px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--b); font-size:12px; }
    .list, .log{ height: 180px; overflow:auto; border:1px solid var(--b); border-radius:12px; padding:10px; background:#fff; }
    ol{ margin:0; padding-left: 18px; }
    .current{ font-weight:700; color: var(--a); }
    .help{ font-size:12px; color:var(--m); margin-top:8px; }
    .error{ color:#b91c1c; margin-top:6px; font-size: 13px; }

    .current-display{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      pointer-events: none;
      text-align: center;
      font-weight: 800;
      color: var(--t);
      background: rgba(255,255,255,0.92);
      padding: 18px 28px;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.12);
      border: 2px solid rgba(37,99,235,0.08);
      opacity: 0;
      transition: opacity 220ms ease;
      font-size: clamp(48px, 18vw, 280px);
      line-height: 1;
      max-width: 92vw;
      word-break: break-word;
    }
    .current-display.show{ opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Lecteur vocal 2 colonnes</h1>
    <div class="muted">Lit chaque ligne « texte + nombre décimal » puis attend votre mot-clé avant la suivante.</div>

    <div class="grid">
      <div class="card">
        <label for="numbers">Tableau 2 colonnes</label>
        <textarea id="numbers" placeholder="Exemple :\nech 1  23\nech 2\t10,2\nech 3\t2,3\nech 4\t5,9\nech 5\t58,9\nech 6\t17,6">ech 1  23
ech 2\t10,2
ech 3\t2,3
ech 4\t5,9
ech 5\t58,9
ech 6\t17,6</textarea>
        <div class="help">
          Format par ligne : <b>texte</b> + séparateur + <b>nombre</b>.<br/>
          Collez directement depuis Excel : sélectionnez 2 colonnes et collez ici.<br/>
          Séparateur accepté : tabulation (Excel), espaces multiples, « ; » ou « , ». Le point est traité comme virgule décimale.
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label for="keyword">Mot-clé à dire</label>
            <input id="keyword" value="OUI" />
            <div class="help">Par défaut : OUI. Modifiable.</div>
          </div>
          <div>
            <label for="lang">Langue</label>
            <select id="lang">
              <option value="fr-FR" selected>fr-FR</option>
              <option value="fr-CA">fr-CA</option>
              <option value="en-US">en-US</option>
              <option value="en-GB">en-GB</option>
              <option value="de-DE">de-DE</option>
              <option value="es-ES">es-ES</option>
              <option value="it-IT">it-IT</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label for="rate">Vitesse</label>
          <input id="rate" type="range" min="0.6" max="1.6" step="0.1" value="1" />
          <div class="help"><span id="rateVal">1.0</span>x</div>
        </div>
        <div class="controls">
          <button id="startBtn">Démarrer</button>
          <button id="pauseBtn" disabled>Pause</button>
          <button id="resumeBtn" disabled>Reprendre</button>
          <button id="nextBtn" disabled title="Désactivé. L'avancement se fait par le micro.">Suivant</button>
          <button id="resetBtn">Réinitialiser</button>
          <button id="permBtn" title="Vérifier et autoriser le micro">Autoriser le micro</button>
        </div>
        <div id="permHelp" class="help" style="display:none"></div>
        <div class="status">État : <span class="pill" id="status">Prêt</span></div>
        <div class="error" id="error" hidden></div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <label>Aperçu</label>
        <div class="list" id="preview"></div>
      </div>
      <div class="card">
        <label>Journal</label>
        <div class="log" id="log"></div>
      </div>
    </div>

    <div class="help" style="margin-top:12px">
      Utilisez Chrome ou Edge. MICRO OBLIGATOIRE pour avancer. HTTPS ou localhost requis pour la reco vocale.
    </div>
  </div>

  <div id="currentDisplay" class="current-display" aria-live="polite" aria-hidden="true"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const numbersEl = $('#numbers');
    const keywordEl = $('#keyword');
    const langEl = $('#lang');
    const rateEl = $('#rate');
    const rateValEl = $('#rateVal');
    const startBtn = $('#startBtn');
    const pauseBtn = $('#pauseBtn');
    const resumeBtn = $('#resumeBtn');
    const nextBtn = $('#nextBtn');
    const resetBtn = $('#resetBtn');
    const permBtn  = $('#permBtn');
    const statusEl = $('#status');
    const errorEl = $('#error');
    const previewEl = $('#preview');
    const logEl = $('#log');
    const currentDisplay = $('#currentDisplay');

    const Phase = { idle:'idle', speaking:'speaking', waiting:'waiting_keyword', paused:'paused', done:'done' };

    let phase = Phase.idle;
    let currentIndex = -1;
    let currentRows = [];
    let synth = window.speechSynthesis;
    let voices = [];
    let ttsWarmedUp = false;
    let rec = null;
    let stopRec = () => {};

    function ts(){ return new Date().toLocaleTimeString(); }
    function log(msg){ const div = document.createElement('div'); div.textContent = ts()+" "+msg; logEl.prepend(div); while(logEl.children.length>400) logEl.removeChild(logEl.lastChild); }
    function setStatus(text){ statusEl.textContent = text; }
    function setError(msg){ if(!msg){ errorEl.hidden=true; errorEl.textContent=''; return;} errorEl.hidden=false; errorEl.textContent = msg; }
    function normalize(s){
      return s.toLowerCase().normalize('NFD').replace(/\\p{Diacritic}+/gu,'').replace(/[\\s\\.,;:!?]+/g,' ').trim();
    }

    // --- NEW: parse 2 columns ---
    
    // --- NEW: parse 2 columns robustly ---
    function parseNumbers(text){
      const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
      const rows = [];
      for(const line of lines){
        // Prefer explicit 2-column split: tab, 2+ spaces, semicolon, or comma followed by space
        const m = line.match(/^(.*?)(?:\t|\s{2,}|;|,)\s*([+-]?\d+(?:[\.,]\d+)?)(?:\s*)$/);
        let label, value;
        if(m){
          label = m[1].trim();
          value = m[2].trim();
        }else{
          // Fallback: take the last number in the line as the value
          const m2 = line.match(/^(.*?)([+-]?\d+(?:[\.,]\d+)?)(?!.*\d)/);
          if(m2){
            label = m2[1].trim();
            value = m2[2].trim();
          }else{
            rows.push(line);
            continue;
          }
        }
        if(/\d+\.\d+/.test(value)) value = value.replace('.', ',');
        value = value.replace(/\s+(?=\d{3}(\D|$))/g, '');
        rows.push(label ? `${label} ${value}` : value);
      }
      return rows;
    }

    function renderPreview(){
      previewEl.innerHTML='';
      const ol = document.createElement('ol');
      ol.style.margin=0; ol.style.paddingLeft='18px';
      if(currentRows.length===0){ const d=document.createElement('div'); d.className='help'; d.textContent='(vide)'; previewEl.appendChild(d); return; }
      currentRows.forEach((row,i)=>{
        const li=document.createElement('li');
        li.textContent=row; if(i===currentIndex) li.className='current'; ol.appendChild(li);
      });
      previewEl.appendChild(ol);
    }

    function updateNumbers(){ currentRows = parseNumbers(numbersEl.value || ''); renderPreview(); updateButtons(); }

    function setPhase(p){ phase = p; const map={ idle:'Prêt', speaking:'Lecture en cours', waiting:`En pause. Dites \"${keywordEl.value}\" pour continuer`, paused:'En pause', done:'Terminé' }; setStatus(map[p]); updateButtons(); }

    function updateButtons(){
      startBtn.disabled = !(currentRows.length>0 && (phase===Phase.idle || phase===Phase.done || phase===Phase.paused));
      pauseBtn.disabled = !(phase===Phase.speaking || phase===Phase.waiting);
      resumeBtn.disabled = !(phase===Phase.paused);
      nextBtn.disabled = true;
    }

    function showCurrentDisplay(text){
      currentDisplay.textContent = text;
      currentDisplay.setAttribute('aria-hidden','false');
      currentDisplay.classList.add('show');
    }
    function hideCurrentDisplay(){
      currentDisplay.classList.remove('show');
      currentDisplay.setAttribute('aria-hidden','true');
    }

    
    // Ensure voices are ready before first speak
    function waitForVoices(timeoutMs=1200){
      return new Promise(resolve => {
        const start = Date.now();
        function check(){
          if(voices && voices.length){ resolve(); return; }
          if(Date.now() - start > timeoutMs){ resolve(); return; }
          setTimeout(check, 80);
        }
        check();
      });
    }
    function loadVoices(){ voices = synth.getVoices(); }
    loadVoices(); if(window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = loadVoices; }

    async function speak(text){
      await waitForVoices(); return new Promise((resolve,reject)=>{
        if(!window.speechSynthesis){ reject(new Error('Synthèse vocale indisponible')); return; }
        try{ window.speechSynthesis.cancel(); }catch{}
        if(!ttsWarmedUp){ try{ const warm = new SpeechSynthesisUtterance(' '); warm.volume = 0; warm.rate = 1; warm.lang = langEl.value; window.speechSynthesis.speak(warm); ttsWarmedUp = true; }catch{} }
        const u = new SpeechSynthesisUtterance(text);
        u.lang = langEl.value;
        u.rate = parseFloat(rateEl.value||'1');
        const preferred = voices.find(v=>v.lang===u.lang) || voices.find(v=>v.lang && v.lang.startsWith(u.lang.split('-')[0]));
        if(preferred) u.voice = preferred;
        u.onend = ()=> resolve();
        u.onerror = (e)=> reject(e.error||new Error('Erreur TTS'));
        window.speechSynthesis.speak(u);
      });
    }

    const isSecureContextInfo = location.protocol === 'https:' || location.hostname === 'localhost';
    async function requestMicrophonePermission(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showPermHelp('Navigateur non compatible micro.');
        return false;
      }
      try{
        const perm = await (navigator.permissions?.query?.({ name: 'microphone' }));
        if(perm && perm.state === 'denied'){ showPermHelp('Permission micro refusée.'); return false; }
      }catch(_){}
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(t=>t.stop());
        hidePermHelp(); log('Micro autorisé.'); return true;
      }catch(err){
        log('Accès micro refusé: ' + (err?.name || err?.message || 'inconnu'));
        showPermHelp('Autorisez le micro pour ce site.');
        return false;
      }
    }
    function showPermHelp(msg){
      const el = document.getElementById('permHelp'); if(!el) return;
      const tips = [];
      if(msg) tips.push(msg);
      if(!isSecureContextInfo){ tips.push('Servez la page en HTTPS ou depuis localhost.'); }
      tips.push(\"Chrome : chrome://settings/content/microphone\");
      tips.push('macOS : Réglages → Confidentialité → Microphone.');
      tips.push('Windows : Paramètres → Confidentialité → Microphone.');
      el.innerHTML = '<ul style=\"margin:8px 0 0 18px; padding:0;\">' + tips.map(t=>`<li>${t}</li>`).join('') + '</ul>';
      el.style.display='block';
    }
    function hidePermHelp(){ const el = document.getElementById('permHelp'); if(el){ el.style.display='none'; el.innerHTML=''; } }

    function getRecognition(){ const C = window.SpeechRecognition || window.webkitSpeechRecognition; return C ? new C() : null; }
function isRecognitionAvailable(){ return !!(window.SpeechRecognition || window.webkitSpeechRecognition); }
    function startRecognition(onKeyword){
      const r = getRecognition();
      if(!r){ setError('Reconnaissance vocale requise pour avancer.'); log('Reconnaissance non supportée'); setPhase(Phase.paused); return ()=>{}; }
      r.lang = langEl.value; r.interimResults = true; r.continuous = false;
      const target = normalize(keywordEl.value||'');
      const onResult = (ev)=>{
        let heard=''; for(const res of ev.results){ heard += res[0]?.transcript || ''; }
        const cleaned = normalize(heard); log(`Entendu: \"${cleaned}\"`);
        if(target && cleaned.includes(target)){
          try{ r.onresult = null; r.onend=null; r.onerror=null; }catch{}
          try{ r.stop(); }catch{} onKeyword();
        }
      };
      const onError = (e)=>{ log('Erreur reco: '+(e.error||'inconnue')); setError('Erreur de reconnaissance: '+(e.error||'inconnue')); setPhase(Phase.paused); };
      const onEnd = ()=>{ if(phase===Phase.waiting){ try{ r.start(); }catch{} } };
      r.onresult=onResult; r.onerror=onError; r.onend=onEnd;
      try{ r.start(); rec=r; log('En écoute du mot-clé...'); }catch(e){ setError('Impossible de démarrer l\\'écoute'); }
      return ()=>{ try{ r.onresult=null; r.onend=null; r.onerror=null; r.stop(); r.abort(); }catch{} };
    }

    async function runFrom(i){
      if(currentRows.length===0) return;
      setPhase(Phase.speaking); currentIndex = i; renderPreview();
      const token = currentRows[i]; // full \"label number\" string
      showCurrentDisplay(token);
      try{
        await speak(token);
        setPhase(Phase.waiting);
        stopRec = startRecognition(()=>{
          log('Mot-clé détecté → suivant');
          const next = i+1;
          if(next >= currentRows.length){
            setPhase(Phase.done); currentIndex = next;
            try{ rec && rec.abort(); }catch{} renderPreview(); hideCurrentDisplay();
          } else { runFrom(next); }
        });
      }catch(e){
        setError('Erreur de lecture');
        setPhase(Phase.paused);
      }
    }

    async function start(){
      if(!(location.protocol === 'https:' || location.hostname === 'localhost')){ setError('HTTPS requis. Ouvrez via GitHub Pages ou localhost.'); setPhase(Phase.paused); return; }
      setError(''); logEl.innerHTML=''; currentIndex=-1;
      if(!isRecognitionAvailable()){ setError('Reconnaissance vocale requise pour avancer. Utilisez Chrome/Edge sur HTTPS.'); setPhase(Phase.paused); return; }
      const granted = await requestMicrophonePermission();
      if(!granted){ setError('Micro requis pour contrôler l\'avancement. Autorisez le micro.'); showPermHelp('Autorisez le micro pour ce site.'); setPhase(Phase.paused); return; }
      await waitForVoices(); runFrom(0);
    }
    function pause(){ try{ window.speechSynthesis.cancel(); }catch{} try{ rec && rec.abort(); }catch{} setPhase(Phase.paused); }
    function resume(){ if(phase!==Phase.paused) return; const idx = Math.max(0,currentIndex); runFrom(idx); }
    function nextManual(){ try{ window.speechSynthesis.cancel(); }catch{} try{ rec && rec.abort(); }catch{} const next = Math.min(currentRows.length, (currentIndex<0?0:currentIndex+1)); if(next>=currentRows.length){ setPhase(Phase.done); currentIndex=next; renderPreview(); hideCurrentDisplay(); } else { runFrom(next); } }
    function resetAll(){ try{ window.speechSynthesis.cancel(); }catch{} try{ rec && rec.abort(); }catch{} setPhase(Phase.idle); currentIndex=-1; logEl.innerHTML=''; setError(''); renderPreview(); hideCurrentDisplay(); }

    numbersEl.addEventListener('input', updateNumbers);
    rateEl.addEventListener('input', ()=>{ rateValEl.textContent = parseFloat(rateEl.value).toFixed(1); });
    startBtn.addEventListener('click', ()=>{ try{ start(); }catch(e){ setError('Erreur start: '+(e&&e.message||e)); } });
    pauseBtn.addEventListener('click', ()=>{ try{ pause(); }catch(e){ setError('Erreur pause: '+(e&&e.message||e)); } });
    resumeBtn.addEventListener('click', ()=>{ try{ resume(); }catch(e){ setError('Erreur resume: '+(e&&e.message||e)); } });
    nextBtn.addEventListener('click', ()=>{ try{ nextManual(); }catch(e){ setError('Erreur suivant: '+(e&&e.message||e)); } });
    resetBtn.addEventListener('click', resetAll);
    permBtn.addEventListener('click', requestMicrophonePermission);

    const _setPhase = setPhase; setPhase = function(p){ _setPhase(p); pauseBtn.disabled=!(phase===Phase.speaking||phase===Phase.waiting); resumeBtn.disabled=!(phase===Phase.paused); nextBtn.disabled = true; };

    updateNumbers(); setPhase(Phase.idle);
  
    // Handle direct paste from Excel (2 columns)
    numbersEl.addEventListener('paste', (e) => {
      try{
        const data = (e.clipboardData || window.clipboardData).getData('text');
        if(!data) return;
        // Detect if content contains tabs or typical Excel CSV formatting
        const looksLikeExcel = /\t/.test(data) || /;|,/.test(data);
        if(!looksLikeExcel) return; // let default paste happen
        e.preventDefault();
        const lines = data.replace(/\r\n?/g, '\n').split('\n').filter(Boolean);
        const out = [];
        for(const raw of lines){
          // Try tab first, then semicolon/comma with 2 fields
          let cells = raw.split('\t');
          if(cells.length < 2){
            const m = raw.match(/^(.*?)[;,]\s*(.+)$/);
            if(m) cells = [m[1], m[2]];
          }
          if(cells.length >= 2){
            const label = cells.slice(0, cells.length-1).join(' ').trim();
            let value = String(cells[cells.length-1]).trim();
            // Normalize decimal separators: keep comma, convert lone dot-decimals to comma
            if(/\d+\.\d+/.test(value) && !/,\d+/.test(value)) value = value.replace('.', ',');
            // Remove thousand separators like space or comma in 1 234,56 or 1,234.56
            value = value.replace(/\s+(?=\d{3}(\D|$))/g, '');
            value = value.replace(/(?<=\d),(?=\d{3}(\D|$))/g, '');
            out.push(label + '\t' + value);
          }else{
            out.push(raw.trim());
          }
        }
        // Insert normalized text at caret
        const norm = out.join('\n');
        const el = numbersEl;
        const start = el.selectionStart, end = el.selectionEnd;
        const before = el.value.slice(0, start);
        const after  = el.value.slice(end);
        el.value = before + norm + after;
        const pos = before.length + norm.length;
        el.selectionStart = el.selectionEnd = pos;
        updateNumbers();
      }catch(_){ /* fallback to default paste */ }
    });

  </script>
</body>
</html>
